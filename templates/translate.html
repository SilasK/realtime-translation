<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ language_name }}</title>
    <link rel="stylesheet" href="/static/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <header>
        <h1>{{ language_name }}</h1>
    </header>
    <main>
        <div id="translationBox" class="translation-box"></div>
    </main>
    <script>
        const language = "{{ language }}";
        const translationBox = document.getElementById("translationBox");
        let streamingInProgress = false;
        let updateQueue = "";

        // On load, fetch full buffer
        function loadFullContent() {
            fetch(`/translations/${language}?full=true`)
            .then(response => response.json())
            .then(data => {
                translationBox.innerHTML = data.text;
            });
        }


        // Function to stream text letter-by-letter into an element.
        function streamText(text, elem, callback) {
            let index = 0;
            function streamLetter() {
                if (index < text.length) {
                    elem.innerHTML += text[index];
                    index++;
                    setTimeout(streamLetter, 50); // Adjust speed as needed
                } else if (callback) {
                    callback();
                }
            }
            streamLetter();
        }

        // Function to process new update letter-by-letter.
        function processUpdate(newText) {
            streamingInProgress = true;
            // Create a new element for the latest update.
            const updateElem = document.createElement("span");
            updateElem.classList.add("new-update");
            translationBox.appendChild(updateElem);


            streamText(newText, updateElem, () => {
                // After streaming, remove the new-update class.
                updateElem.classList.remove("new-update");
                streamingInProgress = false;
                // If new update content was queued during streaming, process it.
                if (updateQueue.length > 0) {
                    const queuedText = updateQueue;
                    updateQueue = "";
                    processUpdate(queuedText);
                }

            });
        }

        // Poll new translation increments letter-by-letter
        function pollUpdates() {
            fetch(`/translations/${language}`)
            .then(response => response.json())
            .then(data => {
                if (data.text) {
                    // If streaming is already in progress, queue the new text.
                    if (streamingInProgress) {
                        updateQueue += data.text;
                    } else {
                        processUpdate(data.text);
                    }
                }
            })
            .catch(err => console.log("Update error:", err));
        }

        // Load full content once page loads
        loadFullContent();
        // Start polling every second
        setInterval(pollUpdates, 1000);
    </script>
</body>
</html>